{% extends "_core_app/base.html" %}
{% load static %}
{% block title %}Semak &amp; Bayar{% endblock %}

{% block content %}
<style>
    /* ===== address-card styling ===== */
    .address-card {
        cursor: pointer;
        transition: .25s;
    }

    .address-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 0 0 .125rem rgba(13, 110, 253, .25);
    }

    .address-radio:checked+.address-card {
        border-color: #0d6efd;
        background-color: #f0f8ff;
    }
</style>
<section>
    <div class="container">
        <div class="row">
            <!-- ================= KOLUM KIRI ================= -->
            <div class="col-xl-6">
                <div class="flat-spacing tf-page-checkout">

                    {# ---------- BLOK MAKLUMAT (Kiri Atas) ---------- #}
                    <div class="wrap">
                        <h5 class="title mb-3">Alamat Penghantaran</h5>

                        <!-- ── Ringkasan Alamat Dipilih ── -->
                        <div id="alamat-ringkas" class="border rounded p-3 mb-3 bg-light">
                            {% with a=alamat_list.0 %}
                            {% if a %}
                            <strong>{{ a.full_name }}</strong><br>
                            {{ a.address_line1 }}, {{ a.city }}, {{ a.state }} ({{ a.postcode }})<br>
                            <span class="text-muted small">{{ a.phone }}</span>
                            {% else %}
                            <em>Tiada alamat tersimpan</em>
                            {% endif %}
                            {% endwith %}
                        </div>

                        <!-- ── Butang tukar ── -->
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                            data-bs-target="#modalAlamat">
                            Tukar Alamat
                        </button>

                        <!-- ── Borang hantar ke order_review POST ── -->
                        <form id="alamat-form" method="post" class="mt-4">
                            {% csrf_token %}
                            <input type="hidden" name="alamat_id" id="inputAlamat"
                                {% if alamat_list %}value="{{ alamat_list.0.id }}" {% endif %}>

                            <button class="tf-btn">
                                <span class="text">Bayar Sekarang</span>
                            </button>
                        </form>
                    </div>
                    {# ---------- BLOK PILIHAN PEMBAYARAN ---------- #}
                    <div class="wrap">
                        <h5 class="title">Pilih Kaedah Bayaran</h5>

                        <!-- Guna form POST ke order_review view sendiri -->
                        <form id="alamat-form" method="post">
                            {% csrf_token %}
                            <div class="payment-box" id="payment-box">

                                <!-- ToyyibPay (Gateway) -->
                                <div class="payment-item payment-choose-card active">
                                    <label for="toyyib-method" class="payment-header" data-bs-toggle="collapse"
                                        data-bs-target="#toyyib-payment">
                                        <input type="radio" name="payment-method" class="tf-check-rounded"
                                            id="toyyib-method" value="toyyibpay" checked>
                                        <span class="text-title">FPX / Kad (ToyyibPay)</span>
                                    </label>
                                    <div id="toyyib-payment" class="collapse show" data-bs-parent="#payment-box">
                                        <div class="payment-body">
                                            <p class="text-secondary small">
                                                Anda akan dialihkan ke gerbang ToyyibPay untuk bayaran selamat.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- COD / Tunai -->
                                <div class="payment-item">
                                    <label for="cod-method" class="payment-header collapsed" data-bs-toggle="collapse"
                                        data-bs-target="#cod-payment">
                                        <input type="radio" name="payment-method" id="cod-method"
                                            class="tf-check-rounded" value="cod">
                                        <span class="text-title">Bayar semasa terima</span>
                                    </label>
                                    <div id="cod-payment" class="collapse" data-bs-parent="#payment-box">
                                        <div class="payment-body">
                                            <p class="text-secondary small">
                                                Wakil kurier kami akan kutip bayaran semasa penghantaran.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <button class="tf-btn btn-reset mt-3">
                                <span class="text">Bayar Sekarang</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- =============== PEMISAH =============== -->
            <div class="col-xl-1 d-none d-xl-block">
                <div class="line-separation"></div>
            </div>
            <div class="modal fade" id="modalAlamat" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Pilih Alamat</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            {% if alamat_list %}
                            {% for a in alamat_list %}
                            <div class="form-check border rounded p-3 mb-2">
                                <input class="form-check-input" type="radio" name="modal_alamat"
                                    id="addr{{ forloop.counter }}" value="{{ a.id }}"
                                    {% if forloop.first %}checked{% endif %}>
                                <label class="form-check-label w-100" for="addr{{ forloop.counter }}">
                                    <strong>{{ a.full_name }}</strong><br>
                                    {{ a.address_line1 }}{% if a.address_line2 %}, {{ a.address_line2 }}{% endif %}<br>
                                    {{ a.postcode }} {{ a.city }}, {{ a.state }}<br>
                                    <span class="text-muted small">{{ a.phone }}</span>
                                </label>
                            </div>
                            {% endfor %}
                            {% else %}
                            <div class="alert alert-warning">
                                Tiada alamat disimpan. <a href="{% url 'profile:alamat-baru' %}">Tambah Alamat</a>.
                            </div>
                            {% endif %}
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button type="button" id="btn-guna-alamat" class="btn btn-primary">Guna Alamat</button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ================= KOLUM KANAN ================= -->
            <div class="col-xl-5">
                <div class="flat-spacing flat-sidebar-checkout">
                    <div class="sidebar-checkout-content">

                        <h5 class="title">Troli Anda</h5>
                        <div class="list-product">

                            {% for item in order.items.all %}
                            <div class="item-product">
                                <a href="{{ item.variant.product.get_absolute_url }}" class="img-product">
                                    {% with img=item.variant.product.images.all|first %}
                                    {% if img %}
                                    <img src="{{ img.image.url }}" alt="img-product">
                                    {% else %}
                                    <img src="{% static 'images/placeholder.png' %}" alt="img-product">
                                    {% endif %}
                                    {% endwith %}
                                </a>
                                <div class="content-box">
                                    <div class="info">
                                        <a href="{{ item.variant.product.get_absolute_url }}"
                                            class="name-product link text-title">{{ item.variant.product.product_name }}</a>
                                        <div class="variant text-caption-1 text-secondary">
                                            <span class="size">{{ item.variant.variant_name }}</span>
                                        </div>
                                    </div>
                                    <div class="total-price text-button">
                                        <span class="count">{{ item.quantity }}</span> ×
                                        <span class="price">RM {{ item.unit_price|floatformat:2 }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                        </div>

                        <!-- Ringkasan Harga -->
                        <div class="sec-total-price mt-4">
                            <div class="top text-button">
                                <div class="d-flex justify-content-between">
                                    <span>Penghantaran</span>
                                    <span>RM {{ order.shipping_fee|floatformat:2 }}</span>
                                </div>
                            </div>
                            <div class="bottom mt-2">
                                <h5 class="d-flex justify-content-between">
                                    <span>Jumlah</span>
                                    <span class="total-price-checkout">
                                        RM {{ order.total_products|add:order.shipping_fee|floatformat:2 }}
                                    </span>
                                </h5>
                            </div>
                        </div>

                    </div> <!-- sidebar-checkout-content -->
                </div>
            </div>
        </div><!-- row -->
    </div><!-- container -->
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ringkas = document.getElementById('alamat-ringkas');
        const inputId = document.getElementById('inputAlamat');
        const gunaBtn = document.getElementById('btn-guna-alamat');

        gunaBtn ?.addEventListener('click', () => {
            // alamat yang dipilih dalam modal
            const chosen = document.querySelector('input[name="modal_alamat"]:checked');
            if (!chosen) return;

            // salin ID ke input tersembunyi
            inputId.value = chosen.value;

            // kemas kini ringkasan alamat pada page
            const label = chosen.nextElementSibling.innerHTML;
            ringkas.innerHTML = label;

            // tutup modal
            bootstrap.Modal.getInstance(document.getElementById('modalAlamat')).hide();
        });
    });
</script>

{% endblock %}